#!/usr/bin/env ruby

lib = File.expand_path(File.join( File.dirname(__FILE__), '../lib' ))
$LOAD_PATH.unshift(lib) if File.directory?(lib) && !$LOAD_PATH.include?(lib)

require 'html2nagioscontacts'

module Html2nagioscontacts

  def self.usage
    puts <<-EOS
  USAGE: #{File.basename(__FILE__)} configfile
    configfile: The path to the config file
                A default configfile you can use as a template is
                located at: #{File.expand_path(File.join( File.dirname(__FILE__), '../lib/html2nagioscontacts/default_config.yml' ))}
    EOS
    exit 1
  end

  def self.main

    args = ARGV.dup
    ARGV.clear

    usage if args.length != 1

    configfile = args.shift

    unless File.exists? configfile
      logger.error "Config file does not exist"
      exit 2
    end

    begin
      Settings.load! configfile
    rescue Exception => e
      logger.fatal "Couldn't load settings: " + e.message
      exit 3
    end

    begin

      parser = Parser.new
      parser.url = Settings.parser['url']
      results = parser.parse

      nagios = Nagios.new
      nagios.prepare_source(results)
      contacts = nagios.create_contacts results

      output = nagios.contacts2string(contacts)
      output_old = ""
      if File.exists?(Settings.generated_contacts_path)
        output_old = File.read(Settings.generated_contacts_path)
      end

      if output.gsub(/#.*?$/, '') == output_old.gsub(/#.*?$/, '')
        logger.info "Nothing changed in config file, exiting"
        exit 0
      end

      File.write Settings.generated_contacts_path, output

    rescue SystemExit
    rescue Exception => e
      logger.fatal "An unhandeled error occured: " + e.message
      logger.fatal e.backtrace.join("\n")
      exit 5
    end
  end
end

Html2nagioscontacts.main

