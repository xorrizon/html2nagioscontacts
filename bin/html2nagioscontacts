#!/usr/bin/env ruby

lib = File.expand_path(File.join( File.dirname(__FILE__), '../lib' ))
$LOAD_PATH.unshift(lib) if File.directory?(lib) && !$LOAD_PATH.include?(lib)

require 'html2nagioscontacts'

module Html2nagioscontacts

  def usage
    puts <<-EOS
  USAGE: #{__FILE__} configfile
    configfile: The path to the config file
                A default configfile you can use as a template is
                located at: #{File.expand_path(File.join( File.dirname(__FILE__), '../lib/html2nagioscontacts/default_config.yml' ))}
    EOS
    exit 1
  end

  args = ARGV.dup
  ARGV.clear

  usage if args.length != 1

  configfile = args.shift

  unless File.exists? configfile
    logger.error "Config file does not exist"
    exit 2
  end

  begin
    Settings.load! configfile
  rescue Exception => e
    logger.fatal "Couldn't load settings: " + e.message
    exit 3
  end

  begin

    parser = Parser.new
    parser.url = Settings.parser['url']
    results = parser.parse

    nagios = Nagios.new
    nagios.prepare_source(results)
    contacts = nagios.create_contacts results

    File.open(Settings.generated_contacts_path, 'w') do |f|
      f.puts "# This file is automatically generated by html2nagioscontacts"
      f.puts "# Changes to this file will be overwritten"
      f.puts "# Last update: " + Time.now.to_s
      f.puts
      NagiosConfig::Formater.new(f).format(contacts)
    end

  rescue Exception => e
    logger.fatal "An unhandeled error occured: " + e.message
    logger.fatal e.backtrace.join("\n")
    exit 5
  end

end
